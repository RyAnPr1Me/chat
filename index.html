<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Mode Chat Room</title>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --primary-color: #6200ee;
            --secondary-color: #3700b3;
            --surface-color: #1e1e1e;
            --error-color: #cf6679;
            --success-color: #4caf50;
            --border-color: #333333;
            --input-bg: #2d2d2d;
            --hover-color: #3e3e3e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            overflow: hidden;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: var(--surface-color);
            border-radius: 10px 10px 0 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .brand {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        
        .chat-sidebar {
            display: flex;
            flex-direction: column;
            width: 250px;
            background-color: var(--surface-color);
            border-right: 1px solid var(--border-color);
            height: 100%;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .chat-main {
            display: flex;
            flex-grow: 1;
            height: calc(100vh - 2rem);
            border-radius: 10px;
            background-color: var(--surface-color);
            overflow: hidden;
        }
        
        .chat-messages {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .messages-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .message {
            max-width: 80%;
            padding: 0.8rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }
        
        .message-outgoing {
            align-self: flex-end;
            background-color: var(--primary-color);
            border-bottom-right-radius: 0.2rem;
        }
        
        .message-incoming {
            align-self: flex-start;
            background-color: var(--input-bg);
            border-bottom-left-radius: 0.2rem;
        }
        
        .message-system {
            align-self: center;
            background-color: var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .message-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            opacity: 0.7;
        }
        
        .chat-input {
            display: flex;
            gap: 10px;
            padding: 1rem;
            background-color: var(--surface-color);
            border-top: 1px solid var(--border-color);
        }
        
        .message-input {
            flex-grow: 1;
            padding: 0.8rem 1rem;
            border-radius: 1.5rem;
            border: none;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 1rem;
            outline: none;
        }
        
        .message-input:focus {
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        
        .send-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .send-button:hover {
            background-color: var(--secondary-color);
        }
        
        .send-button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        
        .room-list {
            margin-top: 1rem;
        }
        
        .room-item {
            padding: 0.8rem;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .room-item:hover {
            background-color: var(--hover-color);
        }
        
        .room-item.active {
            background-color: var(--primary-color);
        }
        
        .sidebar-header {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            opacity: 0.7;
        }
        
        .user-list {
            margin-top: 2rem;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0.5rem;
            border-radius: 5px;
            margin-bottom: 0.5rem;
        }
        
        .user-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-online {
            background-color: var(--success-color);
        }
        
        .status-offline {
            background-color: var(--error-color);
        }
        
        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .theme-toggle:hover {
            background-color: var(--hover-color);
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.85rem;
            z-index: 1000;
            transition: opacity 0.3s;
            opacity: 0;
        }
        
        .connection-status.show {
            opacity: 1;
        }
        
        .status-connected {
            background-color: var(--success-color);
            color: white;
        }
        
        .status-disconnected {
            background-color: var(--error-color);
            color: white;
        }
        
        .status-connecting {
            background-color: #ff9800;
            color: white;
        }
        
        .create-room {
            padding: 0.5rem;
            border-radius: 5px;
            background-color: var(--input-bg);
            margin-top: 1rem;
            display: flex;
            gap: 5px;
        }
        
        .create-room-input {
            flex-grow: 1;
            background: none;
            border: none;
            color: var(--text-color);
            outline: none;
        }
        
        .create-room-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 3px;
            padding: 0.3rem 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        @media (max-width: 768px) {
            .chat-main {
                flex-direction: column;
            }
            
            .chat-sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-main">
            <div class="chat-sidebar">
                <div class="sidebar-header">Rooms</div>
                <div class="room-list" id="roomList">
                    <!-- Room items will be added here -->
                </div>
                
                <div class="create-room">
                    <input type="text" class="create-room-input" id="createRoomInput" placeholder="New room name">
                    <button class="create-room-button" id="createRoomButton">Create</button>
                </div>
                
                <div class="sidebar-header">Online Users</div>
                <div class="user-list" id="userList">
                    <!-- User items will be added here -->
                </div>
            </div>
            
            <div class="chat-messages">
                <div class="chat-header">
                    <div class="brand">Dark Chat</div>
                    <div class="user-info">
                        <button class="theme-toggle" id="themeToggle">‚òÄÔ∏è</button>
                        <div class="user-avatar" id="userAvatar"></div>
                        <div class="username" id="username"></div>
                    </div>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <!-- Messages will be added here -->
                </div>
                
                <div class="chat-input">
                    <input type="text" class="message-input" id="messageInput" placeholder="Type a message...">
                    <button class="send-button" id="sendButton" disabled>
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="connection-status" id="connectionStatus"></div>
    
    <script>
        // Add this at the start of your script section
        const CONFIG = {
            MAX_MESSAGE_LENGTH: 1000,
            MAX_RECONNECT_ATTEMPTS: 3,
            RECONNECT_DELAY: 2000,
            CONNECTION_TIMEOUT: 5000,
            VALID_USERNAME_REGEX: /^[a-zA-Z0-9_-]{3,20}$/,
            VALID_ROOM_NAME_REGEX: /^[a-zA-Z0-9_-]{3,30}$/,
            THEME_STORAGE_KEY: 'darkMode'
        };

        // DOM Elements
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const roomList = document.getElementById('roomList');
        const userList = document.getElementById('userList');
        const themeToggle = document.getElementById('themeToggle');
        const userAvatar = document.getElementById('userAvatar');
        const usernameElement = document.getElementById('username');
        const connectionStatus = document.getElementById('connectionStatus');
        const createRoomInput = document.getElementById('createRoomInput');
        const createRoomButton = document.getElementById('createRoomButton');
        
        // App State
        let socket;
        let currentUser = null;
        let currentRoom = 'general';
        let darkMode = true;
        let users = [];
        let rooms = ['general', 'random', 'support'];
        let isConnected = false;
        let reconnectAttempts = 0;
        let reconnectInterval;
        
        // Initialize chat
        function initChat() {
            console.log('Initializing chat...');
            setupEventListeners();
            initializeSocket().then(setupUser);
            setupThemeToggle();
        }
        
        // Setup user data
        function setupUser() {
            // Generate a random user ID for the current user
            const userId = Math.floor(Math.random() * 1000) + 10;
            
            // Prompt for username
            let username = prompt('Enter your username:');
            while (!username || username.trim() === '') {
                username = prompt('Username cannot be empty. Please enter a valid username:');
            }
            
            // Set current user
            currentUser = {
                id: userId,
                username: username.toLowerCase(),
                online: true
            };
            
            // Update user avatar and username
            userAvatar.textContent = username[0].toUpperCase();
            usernameElement.textContent = username;
            console.log('User setup complete:', currentUser);
        }
        
        // Initialize WebSocket connection
        async function initializeSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.hostname;
            const port = window.location.port || (protocol === 'wss:' ? '443' : '80');
            
            return new Promise((resolve, reject) => {
                try {
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.close();
                    }

                    socket = new WebSocket(`${protocol}//${host}:${port}/ws`);
                    console.log('WebSocket created:', socket);
                    setupSocketEvents(resolve, reject);
                    updateConnectionStatus('connecting', 'Connecting to server...');
                } catch (error) {
                    console.error('WebSocket creation error:', error);
                    updateConnectionStatus('disconnected', 'Failed to connect to server');
                    reject(error);
                }
            });
        }

        // Setup WebSocket event handlers
        function setupSocketEvents(resolve, reject) {
            const connectionTimeout = setTimeout(() => {
                if (socket.readyState !== WebSocket.OPEN) {
                    socket.close();
                    reject(new Error('Connection timeout'));
                    updateConnectionStatus('disconnected', 'Connection timeout');
                }
            }, CONFIG.CONNECTION_TIMEOUT);
        
            socket.addEventListener('open', () => {
                clearTimeout(connectionTimeout);
                isConnected = true;
                if (reconnectInterval) {
                    clearTimeout(reconnectInterval);
                    reconnectInterval = null;
                }
                updateConnectionStatus('connected', 'Connected to server');
                reconnectAttempts = 0;
                console.log('WebSocket connection opened');
                resolve();
            });
        
            socket.addEventListener('message', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (!data.type) {
                        throw new Error('Invalid message format');
                    }
                    console.log('WebSocket message received:', data);
                    onSocketMessage(event);
                } catch (error) {
                    console.error('Message handling error:', error);
                    showError('Invalid message received');
                }
            });
        
            socket.addEventListener('close', () => {
                isConnected = false;
                const message = reconnectAttempts < CONFIG.MAX_RECONNECT_ATTEMPTS
                    ? `Disconnected. Reconnecting (${reconnectAttempts + 1}/${CONFIG.MAX_RECONNECT_ATTEMPTS})...`
                    : 'Connection failed. Please refresh the page.';
                    
                updateConnectionStatus('disconnected', message);
                console.log('WebSocket connection closed');
        
                if (reconnectAttempts < CONFIG.MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    reconnectInterval = setTimeout(() => {
                        initializeSocket().then(setupUser).catch(console.error);
                    }, CONFIG.RECONNECT_DELAY);
                }
            });
        
            socket.addEventListener('error', (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus('error', 'Connection error occurred');
                reject(error);
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Send message on button click
            sendButton.addEventListener('click', sendMessage);
            
            // Send message on Enter key
            messageInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Enable/disable send button based on input
            messageInput.addEventListener('input', () => {
                sendButton.disabled = messageInput.value.trim() === '';
            });
            
            // Handle room creation
            createRoomButton.addEventListener('click', createRoom);
            
            // Handle theme toggle
            themeToggle.addEventListener('click', toggleTheme);
        }
        
        // Encryption and Decryption functions
        function encryptMessage(message, shift = 3) {
            return message.split('').map(char => {
                const code = char.charCodeAt(0);
                if (code >= 65 && code <= 90) {
                    return String.fromCharCode(((code - 65 + shift) % 26) + 65);
                } else if (code >= 97 && code <= 122) {
                    return String.fromCharCode(((code - 97 + shift) % 26) + 97);
                } else {
                    return char;
                }
            }).join('');
        }

        function decryptMessage(message, shift = 3) {
            return encryptMessage(message, 26 - shift);
        }

        function sendMessage() {
            try {
                const message = messageInput.value.trim();
                validateMessage(message);
                
                if (!isConnected) {
                    throw new Error('Not connected to server');
                }

                const encryptedMessage = encryptMessage(message);
                const messageData = {
                    type: 'message',
                    content: sanitizeInput(encryptedMessage),
                    room: currentRoom,
                    user: currentUser?.username,
                    timestamp: Date.now()
                };

                socket.send(JSON.stringify(messageData));
                console.log('Message sent:', messageData);
                messageInput.value = '';
                sendButton.disabled = true;

                // Render the message immediately
                renderMessage(messageData);
            } catch (error) {
                console.error('Send message error:', error);
                showError(error.message);
            }
        }

        // Handle incoming messages
        function onSocketMessage(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'message') {
                renderMessage(data);
            } else if (data.type === 'user_list') {
                updateUserList(data.users);
            } else if (data.type === 'room_list') {
                updateRoomList(data.rooms);
            }
        }
        
        // Render messages in the chat
        function renderMessage(data) {
            const decryptedMessage = decryptMessage(data.content);
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', data.user === currentUser.username ? 'message-outgoing' : 'message-incoming');
            messageElement.innerHTML = `
                <div>${decryptedMessage}</div>
                <div class="message-meta">
                    <span>${data.user}</span>
                    <span>${new Date(data.timestamp).toLocaleTimeString()}</span>
                </div>
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            console.log('Message rendered:', data);
        }

        function renderMessages() {
            messagesContainer.innerHTML = '';
            // Fetch messages for the current room from the server or local storage
            // For demonstration, we'll use a mock function to get messages
            const messages = getMessagesForRoom(currentRoom);
            messages.forEach(renderMessage);
        }

        function getMessagesForRoom(room) {
            // Mock function to return messages for a room
            // Replace this with actual server call or local storage retrieval
            return [
                { user: 'user1', content: encryptMessage('Hello!', 3), timestamp: Date.now() },
                { user: 'user2', content: encryptMessage('Hi there!', 3), timestamp: Date.now() }
            ];
        }
        
        // Update user list in the sidebar
        function updateUserList(users) {
            userList.innerHTML = '';
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.classList.add('user-item');
                userItem.innerHTML = `
                    <div class="user-avatar">${user.username[0].toUpperCase()}</div>
                    <div class="username">${user.username}</div>
                    <div class="user-status ${user.online ? 'status-online' : 'status-offline'}"></div>
                `;
                userList.appendChild(userItem);
            });
            console.log('User list updated:', users);
        }
        
        // Update room list in the sidebar
        function updateRoomList(rooms) {
            roomList.innerHTML = '';
            rooms.forEach(room => {
                const roomItem = document.createElement('div');
                roomItem.classList.add('room-item');
                roomItem.textContent = room;
                roomItem.addEventListener('click', () => joinRoom(room));
                roomList.appendChild(roomItem);
            });
            console.log('Room list updated:', rooms);
        }
        
        // Join a room
        function joinRoom(room) {
            if (currentRoom !== room) {
                currentRoom = room;
                renderMessages();
                socket.send(JSON.stringify({ type: 'join_room', room: currentRoom, user: currentUser.username }));
                console.log('Joined room:', room);
            }
        }
        
        // Render available rooms in the sidebar
        function renderRooms() {
            rooms.forEach(room => {
                const roomItem = document.createElement('div');
                roomItem.classList.add('room-item');
                roomItem.textContent = room;
                roomItem.addEventListener('click', () => joinRoom(room));
                roomList.appendChild(roomItem);
            });
        }
        
        // Handle room creation
        function createRoom() {
            const newRoomName = createRoomInput.value.trim();
            if (newRoomName && !rooms.includes(newRoomName)) {
                rooms.push(newRoomName);
                createRoomInput.value = '';
                updateRoomList(rooms);
                socket.send(JSON.stringify({ type: 'create_room', room: newRoomName }));
                console.log('Room created:', newRoomName);
            }
        }
        
        // Toggle dark/light theme
        function toggleTheme() {
            try {
                darkMode = !darkMode;
                const theme = {
                    dark: {
                        bg: '#121212',
                        text: '#e0e0e0',
                        primary: '#6200ee',
                        secondary: '#3700b3'
                    },
                    light: {
                        bg: '#ffffff',
                        text: '#121212',
                        primary: '#6200ee',
                        secondary: '#3700b3'
                    }
                };

                const currentTheme = darkMode ? theme.dark : theme.light;
                
                Object.entries(currentTheme).forEach(([key, value]) => {
                    document.documentElement.style.setProperty(`--${key}-color`, value);
                });
                
                themeToggle.textContent = darkMode ? '‚òÄÔ∏è' : 'üåô';
                localStorage.setItem(CONFIG.THEME_STORAGE_KEY, darkMode);
                console.log('Theme toggled:', darkMode ? 'dark' : 'light');
            } catch (error) {
                console.error('Theme toggle error:', error);
                showError('Failed to toggle theme');
            }
        }
        
        // Update connection status message
        function updateConnectionStatus(status, message) {
            connectionStatus.textContent = message;
            connectionStatus.classList.remove('status-connected', 'status-disconnected', 'status-connecting');
            connectionStatus.classList.add(`status-${status}`);
            console.log('Connection status updated:', status, message);
        }

        function showError(message, duration = 3000) {
            updateConnectionStatus('error', message);
            setTimeout(() => {
                if (isConnected) {
                    updateConnectionStatus('connected', 'Connected to server');
                }
            }, duration);
        }

        function sanitizeInput(input) {
            return input
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .trim();
        }

        function validateMessage(message) {
            if (!message) {
                throw new Error('Message cannot be empty');
            }
            if (message.length > CONFIG.MAX_MESSAGE_LENGTH) {
                throw new Error(`Message too long (max ${CONFIG.MAX_MESSAGE_LENGTH} characters)`);
            }
            return true;
        }
        
        // Initialize the chat application on page load
        window.onload = initChat;
    </script>
</body>
</html>
